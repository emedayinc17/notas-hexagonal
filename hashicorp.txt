# Instrucciones y ejemplos de HashiCorp Vault para el proyecto `notas-hexagonal`
# ---------------------------------------------------------------
# Este archivo contiene pasos y comandos ejemplo para:
#  - crear una policy mínima para las apps
#  - habilitar y configurar auth/kubernetes
#  - crear un role que ligue una ServiceAccount a la policy
#  - subir secretos de ejemplo (kv) para los microservicios: iam, academico, personas, notas
#  - ejemplo de anotaciones en el Deployment para usar Vault Agent Inject


# 0) Conectarse a Vault (opción 1: desde fuera del pod)
export VAULT_ADDR="http://vault.vault.svc:8200"

# Opción 2: Si estás dentro del clúster, ejecuta en el pod de Vault
kubectl -n vault exec -it statefulset/vault -c vault -- sh
# Dentro del pod:
export VAULT_ADDR="http://localhost:8200"
# Inicializa y desbloquea si es necesario
vault status
# Si está sellado:
vault operator unseal uAy8EiQpYvLo2DAiN43PiI2GiRiNI8CWN0Au4fVRXFM=


# Obtén el token root (si tienes acceso)
# En producción, usa tokens con privilegios limitados
export VAULT_TOKEN="hvs.YOrWrzKTYAeEJ95twRPyO2p1"

# Verifica conexión
vault status

## 1) Verificar secrets engines disponibles
vault secrets list
# Deberías ver kv/ en la lista

## 2) Crear policy (lectura solo para los paths de la app)
vault policy write notas-hexagonal-app - <<'EOF'
# Permite todas las operaciones CRUD en los datos en kv/
path "kv/data/notas-hexagonal/*" {
  capabilities = ["create", "update", "read", "list", "delete"]
}

# Permite leer metadatos en kv/
path "kv/metadata/notas-hexagonal/*" {
  capabilities = ["read", "list"]
}
EOF

# Verificar política creada
vault policy read notas-hexagonal-app

## 3) Habilitar auth/kubernetes (si no está habilitado)
# Verifica si ya está habilitado
vault auth list

# Si no ves kubernetes, habilítalo
vault auth enable kubernetes

# Configurar auth/kubernetes para que use el servicio de Kubernetes
# Esto generalmente se hace durante la instalación de Vault, pero verifica:
vault write auth/kubernetes/config \
  kubernetes_host="https://kubernetes.default.svc" \
  token_reviewer_jwt="$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)" \
  kubernetes_ca_cert=@/var/run/secrets/kubernetes.io/serviceaccount/ca.crt \
  issuer="https://kubernetes.default.svc.cluster.local"

## 4) Crear el rol que enlaza la ServiceAccount de Kubernetes con la policy
vault write auth/kubernetes/role/notas-hexagonal-role \
  bound_service_account_names=sga-serviceaccount \
  bound_service_account_namespaces=sga \
  policies=notas-hexagonal-app \
  ttl=24h
  # audience=vault  # Opcional: para Vault v1.21+

# Verificar el rol
vault read auth/kubernetes/role/notas-hexagonal-role

## 5) Subir secretos (ejemplos para cada microservicio)
# IAM
vault kv put kv/notas-hexagonal/iam \
  APP_ENV='prod' \
  DB_HOST='mysql.sga.svc.cluster.local' \
  DB_PORT='3306' \
  DB_USER='app_iam' \
  DB_PASS='IAM_2025' \
  DB_NAME='sga_iam' \
  JWT_SECRET='CHANGE_ME_STRONG' \
  ACCESS_TOKEN_EXPIRE_MINUTES='60'

# Academico
vault kv put kv/notas-hexagonal/academico \
  APP_ENV='prod' \
  DB_HOST='mysql.sga.svc.cluster.local' \
  DB_PORT='3306' \
  DB_USER='app_academico' \
  DB_PASS='ACADEMICO_2025' \
  DB_NAME='sga_academico' \
  JWT_SECRET='CHANGE_ME_STRONG' \
  ACCESS_TOKEN_EXPIRE_MINUTES='60'

# Personas
vault kv put kv/notas-hexagonal/personas \
  APP_ENV='prod' \
  DB_HOST='mysql.sga.svc.cluster.local' \
  DB_PORT='3306' \
  DB_USER='app_personas' \
  DB_PASS='PERSONAS_2025' \
  DB_NAME='sga_personas' \
  JWT_SECRET='CHANGE_ME_STRONG' \
  ACCESS_TOKEN_EXPIRE_MINUTES='60'

# Notas
vault kv put kv/notas-hexagonal/notas \
  APP_ENV='prod' \
  DB_HOST='mysql.sga.svc.cluster.local' \
  DB_PORT='3306' \
  DB_USER='app_notas' \
  DB_PASS='NOTAS_2025' \
  DB_NAME='sga_notas' \
  JWT_SECRET='CHANGE_ME_STRONG' \
  ACCESS_TOKEN_EXPIRE_MINUTES='60'

## 6) Verificar secretos (CORREGIDO: usa kv/ en lugar de secret/)
vault kv get kv/notas-hexagonal/iam
vault kv get kv/notas-hexagonal/academico
vault kv get kv/notas-hexagonal/personas
vault kv get kv/notas-hexagonal/notas

# Listar todos los secretos en el path
vault kv list kv/notas-hexagonal

## 7) Probar la autenticación (opcional)
# Para verificar que el rol funciona, puedes probar con:
vault write auth/kubernetes/login role=notas-hexagonal-role jwt=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)

## 8) Ejemplo de Deployment (IAM) usando Vault Agent Inject
# Añade estas anotaciones al `metadata.template.metadata.annotations` de tu Deployment.

# ANOTACIONES CORRECTAS:
vault.hashicorp.com/agent-inject: "true"
vault.hashicorp.com/role: "notas-hexagonal-role"
vault.hashicorp.com/agent-inject-secret-config: "kv/data/notas-hexagonal/iam"
vault.hashicorp.com/agent-inject-template-config: |
  {{- with secret "kv/data/notas-hexagonal/iam" -}}
  APP_NAME="IAM Service"
  APP_ENV={{ .Data.data.APP_ENV }}
  DB_HOST={{ .Data.data.DB_HOST }}
  DB_PORT={{ .Data.data.DB_PORT }}
  DB_USER={{ .Data.data.DB_USER }}
  DB_PASSWORD={{ .Data.data.DB_PASS }}
  DB_NAME={{ .Data.data.DB_NAME }}
  JWT_SECRET_KEY={{ .Data.data.JWT_SECRET }}
  ACCESS_TOKEN_EXPIRE_MINUTES={{ .Data.data.ACCESS_TOKEN_EXPIRE_MINUTES }}
  {{- end }}

## 9) Troubleshooting
# Si los pods no pueden acceder a los secretos:
# 1. Verifica los logs del sidecar de Vault:
kubectl logs <pod-name> -c vault-agent -n sga

# 2. Verifica que la ServiceAccount exista:
kubectl get serviceaccount sga-serviceaccount -n sga

# 3. Verifica que el pod esté usando la ServiceAccount correcta:
kubectl describe pod <pod-name> -n sga | grep ServiceAccount

# 4. Verifica que Vault esté accesible desde el namespace sga:
kubectl exec -it <pod-name> -n sga -- curl -s http://vault.vault.svc:8200/v1/sys/health

## 10) Comandos útiles para administración
# Listar todas las políticas
vault policy list

# Eliminar un secreto
vault kv delete kv/notas-hexagonal/iam

# Rotar secretos
vault kv put kv/notas-hexagonal/iam \
  DB_PASS='NUEVA_CONTRASEÑA_2025' \
  JWT_SECRET='NUEVO_SECRETO_FUERTE'

# Ver metadatos de un secreto
vault kv metadata get kv/notas-hexagonal/iam

# Deshabilitar auth/kubernetes (cuidado)
# vault auth disable kubernetes

---
# Fin de hashicorp.txt