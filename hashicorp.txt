# Instrucciones y ejemplos de HashiCorp Vault para el proyecto `notas-hexagonal`
# ---------------------------------------------------------------
# Este archivo contiene pasos y comandos ejemplo para:
#  - crear una policy mínima para las apps
#  - habilitar y configurar auth/kubernetes
#  - crear un role que ligue una ServiceAccount a la policy
#  - subir secretos de ejemplo (kv) para los microservicios: iam, academico, personas, notas
#  - ejemplo de anotaciones en el Deployment para usar Vault Agent Inject

## 1) Crear policy (lectura solo para los paths de la app)
vault policy write notas-hexagonal-app - <<'EOF'
# Si tu mount KV se llama `secret/` (KV v2) usa los paths `secret/data/...` y `secret/metadata/...`
path "secret/data/notas-hexagonal/*" {
  capabilities = ["read"]
}
path "secret/metadata/notas-hexagonal/*" {
  capabilities = ["read"]
}
# Para permitir escrituras desde la CLI (vault kv put) añade create/update sobre el data path
path "secret/data/notas-hexagonal/*" {
  capabilities = ["create","update","read","list"]
}
EOF

## 1.1) Habilitar auth/kubernetes (si no está habilitado)
vault auth enable kubernetes

## 1.2) Configurar conexión con Kubernetes (ejecutar desde un pod o con credenciales apropiadas)
vault write auth/kubernetes/config \
  token_reviewer_jwt="$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)" \
  kubernetes_host="https://$KUBERNETES_SERVICE_HOST:$KUBERNETES_SERVICE_PORT" \
  kubernetes_ca_cert=@/var/run/secrets/kubernetes.io/serviceaccount/ca.crt \
  issuer="https://kubernetes.default.svc.cluster.local"

## 2) Crear el rol que enlaza la ServiceAccount de Kubernetes con la policy
# Ajusta: bound_service_account_names y bound_service_account_namespaces según tu manifest
vault write auth/kubernetes/role/notas-hexagonal-role \
  bound_service_account_names=sga-serviceaccount \
  bound_service_account_namespaces=sga \
  policies=notas-hexagonal-app \
  ttl=24h \
  audiences=vault

# Verificar el rol
vault read auth/kubernetes/role/notas-hexagonal-role

## 3) Subir secretos (ejemplos para cada microservicio)
# Sustituye valores por los de tu entorno. Usamos path: kv/notas-hexagonal/<servicio>

# IAM
## Nota: en este servidor Vault el mount KV está en `secret/` (KV v2). Usa `vault kv put secret/...` o `vault kv put secret/notas-hexagonal/iam`
vault kv put secret/notas-hexagonal/iam \
  APP_ENV='prod' \
  DB_HOST='mysql.sga.svc.cluster.local' \
  DB_PORT='3306' \
  DB_USER='app_iam' \
  DB_PASS='IAM_2025' \
  DB_NAME='sga_iam' \
  JWT_SECRET='CHANGE_ME_STRONG' \
  ACCESS_TOKEN_EXPIRE_MINUTES='60'

# Academico
vault kv put secret/notas-hexagonal/academico \
  APP_ENV='prod' \
  DB_HOST='mysql.sga.svc.cluster.local' \
  DB_PORT='3306' \
  DB_USER='app_academico' \
  DB_PASS='ACADEMICO_2025' \
  DB_NAME='sga_academico' \
  JWT_SECRET='CHANGE_ME_STRONG' \
  ACCESS_TOKEN_EXPIRE_MINUTES='60'

# Personas
vault kv put secret/notas-hexagonal/personas \
  APP_ENV='prod' \
  DB_HOST='mysql.sga.svc.cluster.local' \
  DB_PORT='3306' \
  DB_USER='app_personas' \
  DB_PASS='PERSONAS_2025' \
  DB_NAME='sga_personas' \
  JWT_SECRET='CHANGE_ME_STRONG' \
  ACCESS_TOKEN_EXPIRE_MINUTES='60'

# Notas
vault kv put secret/notas-hexagonal/notas \
  APP_ENV='prod' \
  DB_HOST='mysql.sga.svc.cluster.local' \
  DB_PORT='3306' \
  DB_USER='app_notas' \
  DB_PASS='NOTAS_2025' \
  DB_NAME='sga_notas' \
  JWT_SECRET='CHANGE_ME_STRONG' \
  ACCESS_TOKEN_EXPIRE_MINUTES='60'

## 4) Verificar secretos
vault kv get secret/notas-hexagonal/iam
vault kv get secret/notas-hexagonal/academico
vault kv get secret/notas-hexagonal/personas
vault kv get secret/notas-hexagonal/notas

## 5) Ejemplo de Deployment (IAM) usando Vault Agent Inject
# Añade estas anotaciones al `metadata.template.metadata.annotations` de tu Deployment.
# Esto inyectará un fichero `/vault/secrets/config` con el contenido renderizado por la plantilla.

vault.hashicorp.com/agent-inject: "true"
vault.hashicorp.com/role: "notas-hexagonal-role"
vault.hashicorp.com/agent-inject-secret-config: "kv/data/notas-hexagonal/iam"
vault.hashicorp.com/agent-inject-template-config: |
  {{- with secret "kv/data/notas-hexagonal/iam" -}}
  APP_ENV={{ .Data.data.APP_ENV }}
  DB_HOST={{ .Data.data.DB_HOST }}
  DB_PORT={{ .Data.data.DB_PORT }}
  DB_USER={{ .Data.data.DB_USER }}
  DB_PASS={{ .Data.data.DB_PASS }}
  DB_NAME={{ .Data.data.DB_NAME }}
  JWT_SECRET={{ .Data.data.JWT_SECRET }}
  ACCESS_TOKEN_EXPIRE_MINUTES={{ .Data.data.ACCESS_TOKEN_EXPIRE_MINUTES }}
  {{- end }}

## 6) Ejemplo de `command/args` dentro del contenedor (para `iam-service`)
# Este fragmento carga el fichero inyectado y exporta las variables antes de arrancar la app
command: ["/bin/sh"]
args:
  - "-c"
  - |
    if [ -f /vault/secrets/config ]; then
      . /vault/secrets/config
    fi
    export DB_HOST="${DB_HOST}"
    export DB_PORT="${DB_PORT}"
    export DB_USER="${DB_USER}"
    export DB_PASS="${DB_PASS}"
    export DB_NAME="${DB_NAME}"
    export JWT_SECRET="${JWT_SECRET}"
    exec uvicorn app.main:app --host 0.0.0.0 --port 8001

## 7) Notas y recomendaciones
- No poner secretos reales en repositorio Git. Usa el script `k8s/scripts/create_k8s_secret_from_env.sh` para generar Secrets temporales si no usas Vault.
- Para producción, usa Vault + External Secrets Operator o Vault Agent Injector para no materializar secretos en YAML.
- Asegúrate que la ServiceAccount usada en el Deployment (`sga-serviceaccount` en nuestro ejemplo) esté asociada con el rol que creaste en Vault (`notas-hexagonal-role`).
- Reemplaza `notas-hexagonal` y los nombres de usuario/DB/contraseñas por los valores reales de tu entorno.

---
# Fin de hashicorp.txt
